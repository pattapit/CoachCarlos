<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#4B2E83" />
  <link rel="manifest" href="manifest.json" />
  <title>CoachCarlos</title>

  <style>
    :root{
      --purple:#4B2E83;          /* Husky Purple */
      --gold:#B7A57A;            /* Husky Gold */
      --goldLight:#E8E3D3;
      --line:#e6e6e6;
      --muted:#666;
      --good:#137333;
      --bad:#b00020;
      --bg:#fff;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      margin:0;background:var(--bg);color:#111;
    }
    header{
      padding:16px;border-bottom:1px solid var(--line);
      position:sticky;top:0;background:#fff;z-index:10;
    }
    h1{margin:0;color:var(--purple);font-size:20px;}
    .sub{font-size:12px;color:var(--muted);margin-top:4px;}

    nav{
      display:flex;gap:10px;padding:12px 16px;border-bottom:1px solid var(--line);
      position:sticky;top:66px;background:#fff;z-index:9;flex-wrap:wrap;
    }
    nav button{
      border:1px solid var(--purple);
      background:#fff;color:var(--purple);
      border-radius:999px;padding:8px 14px;font-weight:800;cursor:pointer;
    }
    nav button.active{background:var(--purple);color:#fff;}

    main{padding:16px;max-width:980px;margin:0 auto;}
    .card{
      border:1px solid var(--line);border-radius:14px;padding:14px;margin:14px 0;
    }
    .card h2{margin:0 0 10px;color:var(--purple);font-size:15px;}
    .tiny{font-size:12px;color:var(--muted);}

    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .row > div{flex:1;min-width:220px;}

    input[type="date"], input[type="text"], select{
      width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;
    }
    textarea{
      width:100%;min-height:90px;padding:10px;border:1px solid var(--line);border-radius:10px;
    }

    .pill{
      display:inline-block;background:var(--goldLight);border:1px solid var(--gold);
      padding:2px 10px;border-radius:999px;font-size:12px;
    }
    .status{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px;
    }
    .badge{
      display:inline-block;padding:3px 10px;border-radius:999px;font-weight:900;font-size:12px;
      border:1px solid var(--line);background:#f7f7f7;
    }
    .badge.live{background:var(--goldLight);border-color:var(--gold);}
    .badge.locked{background:#f5f5ff;border-color:var(--purple);color:var(--purple);}

    .btn{
      border:1px solid var(--purple);
      background:var(--purple);color:#fff;
      padding:10px 14px;border-radius:10px;font-weight:900;cursor:pointer;
    }
    .btn.secondary{background:#fff;color:var(--purple);}
    .btn.danger{border-color:#b00020;background:#b00020;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}

    /* Panels
       FIX: side-by-side by default to reduce scrolling on phones.
       Stack only on very narrow screens where two columns becomes unusable. */
    .panels{
      display:grid;
      grid-template-columns: 1fr 1fr;   /* default: side-by-side */
      gap:12px;
      align-items:start;
    }
    .panel{
      min-width:0;          /* IMPORTANT: allows content to shrink inside grid */
    }
    @media (max-width: 360px){
      .panels{ grid-template-columns: 1fr; } /* stack only on tiny screens */
    }

    .panel{
      border:1px solid var(--line);border-radius:14px;padding:12px;min-width:0;
    }
    .panel h3{margin:0 0 6px;color:#111;font-size:14px;}
    .score{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;
      font-size:13px;
    }
    .score .box{
      border:1px solid var(--line);border-radius:12px;padding:10px;
    }
    .score .box b{display:block;margin-bottom:4px;}
    .good{color:var(--good);font-weight:900;}
    .bad{color:var(--bad);font-weight:900;}

    /* Action buttons:
       Row 1 = ‚úÖ Pass | ‚úÖ Tackle
       Row 2 = ‚ùå Pass | ‚ùå Tackle */
    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-top:10px;
    }
    .act{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:12px;
      font-weight:1000;
      font-size:15px;
      cursor:pointer;
      text-align:left;

      width:100%;
      box-sizing:border-box;
      white-space: normal;
      overflow-wrap: break-word;  /* <-- better */
      word-break: normal;         /* <-- important */
      hyphens: none; 
      line-height:1.15;
      min-height:72px;
    }
    .act:disabled{opacity:.5;cursor:not-allowed;}
    .act.passGood{border-color:#cfe8d6;}
    .act.passBad{border-color:#f3c6c6;}
    .act.tackGood{border-color:#cfe0ff;}
    .act.tackBad{border-color:#ffe4c7;}
    .act.shotGood{border-color:#d4edda;}
    .act.shotBad{border-color:#f8d7da;}
    .act.goalGood{border-color:#b8daff;}
    .act.goalBad{border-color:#ffeaa7;}

    .act span{display:block;font-size:12px;color:var(--muted);font-weight:800;margin-top:4px;}

    /* Tighten just a bit on small phones so buttons stay comfy without scrolling */
    @media (max-width: 520px){
      main{padding:12px;}
      .act{padding:12px;font-size:15px;}
      .score .box{padding:8px;}
    }
    @media (max-width: 520px){
    .act span{ display:none; }
}

    .divider{border:none;border-top:1px dashed var(--line);margin:14px 0;}
    .list-item{
      border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px;
    }
    .kpiGrid{
      display:grid;grid-template-columns:1fr;gap:10px;
    }
    @media (min-width: 800px){
      .kpiGrid{grid-template-columns:1fr 1fr;}
    }
    .kpi{
      border:1px solid var(--line);border-radius:12px;padding:10px;
    }
    .kpi h4{margin:0 0 8px;color:var(--purple);}
    .kpiRow{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .target{font-size:12px;color:var(--muted);margin-top:6px;}

    .miniRow{
      display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;
    }
    .miniRow > div{flex:1;min-width:160px;}
    .chipBtn{
      border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;
      cursor:pointer;font-weight:900;
    }

    .mutebox{
      border:1px solid var(--line);
      background:#fafafa;
      border-radius:12px;
      padding:10px;
      font-size:12px;
      color:#333;
    }

    .tableRow{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .tableRow b{margin-right:8px;}

    .smallBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .smallBtn.warn{border-color:#f0c36d;}
    .smallBtn.danger{border-color:#b00020;color:#b00020;}
    .tagArchived{
      display:inline-block;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f7f7f7;
      margin-left:8px;
      color:#444;
      font-weight:900;
    }
  </style>
</head>

<body>
<header>
  <h1>CoachCarlos</h1>
  <div class="sub">Sideline tracking: passes/tackles + notes. Local on-device.</div>
</header>

<nav>
  <button id="tab-game" class="active" onclick="showTab('game')">Game</button>
  <button id="tab-summary" onclick="showTab('summary')">Summary</button>
  <button id="tab-manage" onclick="showTab('manage')">Manage</button>
</nav>

<main>
  <!-- GAME -->
  <section id="game">
    <div class="card">
      <h2>Game setup</h2>
      <div class="row">
        <div>
          <div class="tiny">Game date</div>
          <input type="date" id="gDate">
        </div>
        <div>
          <div class="tiny">Venue</div>
          <input type="text" id="gVenue" placeholder="Starfire / Arena / etc">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <div class="tiny">Team played for</div>
          <div class="row" style="gap:8px;">
            <div style="flex:1;min-width:220px;">
              <select id="gTeam"></select>
              <div class="tiny" style="margin-top:6px;">Roster teams live in <b>Manage</b>.</div>
            </div>
            <div style="flex:0;min-width:180px;">
              <button class="btn secondary" onclick="addTeam()">+ Add to roster</button>
            </div>
          </div>
        </div>
        <div>
          <div class="tiny">Opponent</div>
          <input type="text" id="gOpp" placeholder="Seattle United / etc">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <div class="tiny">Player A</div>
          <div class="row" style="gap:8px;">
            <div style="flex:1;min-width:220px;">
              <select id="pA"></select>
              <div class="tiny" style="margin-top:6px;">Adds go to roster for <b>future games</b>.</div>
            </div>
            <div style="flex:0;min-width:180px;">
              <button class="btn secondary" onclick="addPlayer()">+ Add to roster</button>
            </div>
          </div>
        </div>
        <div>
          <div class="tiny">Player B</div>
          <div class="row" style="gap:8px;">
            <div style="flex:1;min-width:220px;">
              <select id="pB"></select>
              <div class="tiny" style="margin-top:6px;">Adds go to roster for <b>future games</b>.</div>
            </div>
            <div style="flex:0;min-width:180px;">
              <button class="btn secondary" onclick="addPlayer()">+ Add to roster</button>
            </div>
          </div>
        </div>
      </div>

      <div class="status">
        <span class="badge" id="gameStateBadge">NO GAME LOADED</span>
        <span class="tiny">Selected game: <span class="pill" id="gameKeyPill">‚Äî</span></span>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" id="btnStart" onclick="startGame()">Start game</button>
        <button class="btn" id="btnEnd" onclick="endGame()">End game (Lock)</button>
        <button class="btn secondary" id="btnUnlock" onclick="unlockGame()">Unlock</button>
      </div>

      <div class="tiny" style="margin-top:10px;">
        Tip: Start game locks the date/opp/team/players into a ‚Äúgame session.‚Äù End game locks stats + notes (you can unlock later).
      </div>
    </div>

    <div class="card">
      <h2>Live tracking</h2>

      <div class="panels">
        <div class="panel">
          <h3>Player A: <span class="pill" id="nameA">‚Äî</span></h3>

          <div class="score">
            <div class="box">
              <b>Passes</b>
              ‚úÖ <span id="aPassGood">0</span> / ‚ùå <span id="aPassBad">0</span>
              <div class="tiny">Rate: <span id="aPassRate">‚Äî</span></div>
            </div>
            <div class="box">
              <b>Tackles</b>
              ‚úÖ <span id="aTackGood">0</span> / ‚ùå <span id="aTackBad">0</span>
              <div class="tiny">Rate: <span id="aTackRate">‚Äî</span></div>
            </div>
            <div class="box">
              <b>Shots</b>
              ‚úÖ <span id="aShotGood">0</span> / ‚ùå <span id="aShotBad">0</span>
              <div class="tiny">Rate: <span id="aShotRate">‚Äî</span></div>
            </div>
            <div class="box">
              <b>Goals</b>
              ‚úÖ <span id="aGoalGood">0</span> / ‚ùå <span id="aGoalBad">0</span>
              <div class="tiny">Rate: <span id="aGoalRate">‚Äî</span></div>
            </div>
          </div>

          <div class="actions">
            <button class="act passGood" id="btnAPG" onclick="tap('A','passGood')">‚úÖ Pass <span>successful pass</span></button>
            <button class="act tackGood" id="btnATG" onclick="tap('A','tackGood')">‚úÖ Tackle <span>successful tackle</span></button>
            <button class="act shotGood" id="btnASG" onclick="tap('A','shotGood')">‚úÖ Shot <span>on target</span></button>
            <button class="act goalGood" id="btnAGG" onclick="tap('A','goalGood')">‚úÖ Goal <span>goal scored</span></button>
            <button class="act passBad"  id="btnAPB" onclick="tap('A','passBad')">‚ùå Pass <span>unsuccessful pass</span></button>
            <button class="act tackBad"  id="btnATB" onclick="tap('A','tackBad')">‚ùå Tackle <span>unsuccessful tackle</span></button>
            <button class="act shotBad"  id="btnASB" onclick="tap('A','shotBad')">‚ùå Shot <span>off target</span></button>
            <button class="act goalBad"  id="btnAGB" onclick="tap('A','goalBad')">‚ùå Goal <span>goal missed</span></button>
          </div>

          <div style="margin-top:10px;">
            <button class="btn secondary" id="btnUndoA" onclick="undo('A')">Undo (A)</button>
          </div>
        </div>

        <div class="panel">
          <h3>Player B: <span class="pill" id="nameB">‚Äî</span></h3>

          <div class="score">
            <div class="box">
              <b>Passes</b>
              ‚úÖ <span id="bPassGood">0</span> / ‚ùå <span id="bPassBad">0</span>
              <div class="tiny">Rate: <span id="bPassRate">‚Äî</span></div>
            </div>
            <div class="box">
              <b>Tackles</b>
              ‚úÖ <span id="bTackGood">0</span> / ‚ùå <span id="bTackBad">0</span>
              <div class="tiny">Rate: <span id="bTackRate">‚Äî</span></div>
            </div>
            <div class="box">
              <b>Shots</b>
              ‚úÖ <span id="bShotGood">0</span> / ‚ùå <span id="bShotBad">0</span>
              <div class="tiny">Rate: <span id="bShotRate">‚Äî</span></div>
            </div>
            <div class="box">
              <b>Goals</b>
              ‚úÖ <span id="bGoalGood">0</span> / ‚ùå <span id="bGoalBad">0</span>
              <div class="tiny">Rate: <span id="bGoalRate">‚Äî</span></div>
            </div>
          </div>

          <div class="actions">
            <button class="act passGood" id="btnBPG" onclick="tap('B','passGood')">‚úÖ Pass <span>successful pass</span></button>
            <button class="act tackGood" id="btnBTG" onclick="tap('B','tackGood')">‚úÖ Tackle <span>successful tackle</span></button>
            <button class="act shotGood" id="btnBSG" onclick="tap('B','shotGood')">‚úÖ Shot <span>on target</span></button>
            <button class="act goalGood" id="btnBGG" onclick="tap('B','goalGood')">‚úÖ Goal <span>goal scored</span></button>
            <button class="act passBad"  id="btnBPB" onclick="tap('B','passBad')">‚ùå Pass <span>unsuccessful pass</span></button>
            <button class="act tackBad"  id="btnBTB" onclick="tap('B','tackBad')">‚ùå Tackle <span>unsuccessful tackle</span></button>
            <button class="act shotBad"  id="btnBSB" onclick="tap('B','shotBad')">‚ùå Shot <span>off target</span></button>
            <button class="act goalBad"  id="btnBGB" onclick="tap('B','goalBad')">‚ùå Goal <span>goal missed</span></button>
          </div>

          <div style="margin-top:10px;">
            <button class="btn secondary" id="btnUndoB" onclick="undo('B')">Undo (B)</button>
          </div>
        </div>
      </div>

      <hr class="divider">

      <div class="tiny">Game notes (scratch pad)</div>
      <textarea id="gNotes" placeholder="Halftime thoughts, patterns, coaching notes‚Ä¶"></textarea>
      <div class="tiny" style="margin-top:8px;">Notes are saved with the game. When locked, notes become read-only.</div>
    </div>

    <div class="card">
      <h2>Game picker</h2>

      <div class="mutebox">
        Filters only affect the dropdown list. Selecting a game loads it into the Game tab (same as ‚Äúrecent games‚Äù did).
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <div class="tiny">Filter: Team played for</div>
          <select id="fTeam"></select>
        </div>
        <div>
          <div class="tiny">Filter: Start date</div>
          <input type="date" id="fStart">
        </div>
        <div>
          <div class="tiny">Filter: End date</div>
          <input type="date" id="fEnd">
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn secondary" onclick="clearGameFilters()">Clear filters</button>
      </div>

      <div style="margin-top:12px;">
        <div class="tiny">Select game</div>
        <select id="gamePicker"></select>
        <div class="tiny" style="margin-top:8px;">Pick a game above to load it.</div>
      </div>
    </div>
  </section>

  <!-- SUMMARY -->
  <section id="summary" style="display:none;">
    <div class="card">
      <h2>Summary</h2>

      <div class="row">
        <div>
          <div class="tiny">Mode</div>
          <select id="sumMode" onchange="renderSummary()">
            <option value="aggregate">Aggregate (player totals)</option>
            <option value="gameCompare">Game vs Game (single-game compare)</option>
          </select>
        </div>
        <div>
          <div class="tiny">Range (Aggregate mode)</div>
          <select id="sRange" onchange="renderSummary()">
            <option value="all">All games</option>
            <option value="last5">Last 5 games</option>
            <option value="single">Single game</option>
            <option value="custom">Custom date range</option>
          </select>
        </div>
      </div>

      <div id="aggregateControls" style="margin-top:10px;">
        <div class="row">
          <div>
            <div class="tiny">Player A</div>
            <select id="sPlayerA"></select>
          </div>
          <div>
            <div class="tiny">Player B (optional compare)</div>
            <select id="sPlayerB"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <div class="tiny">Single game</div>
            <select id="sGame"></select>
            <div class="tiny">Used only when Range = Single game.</div>
          </div>
          <div id="customRangeBox" style="display:none;">
            <div class="tiny">Custom range</div>
            <div class="miniRow">
              <div>
                <div class="tiny">Start</div>
                <input type="date" id="sStart">
              </div>
              <div>
                <div class="tiny">End</div>
                <input type="date" id="sEnd">
              </div>
            </div>
            <div class="tiny" style="margin-top:6px;">Inclusive start/end.</div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn secondary" onclick="renderSummary()">Refresh</button>
        </div>
      </div>

      <div id="gameCompareControls" style="display:none;margin-top:10px;">
        <div class="mutebox">
          Pick one game for each side. Players can be different. Great for ‚ÄúSofia vs PacNW‚Äù compared to ‚ÄúHarper vs PacNW ECNL‚Äù.
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <div class="tiny">Left player</div>
            <select id="cPlayerL"></select>
          </div>
          <div>
            <div class="tiny">Left game</div>
            <select id="cGameL"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <div class="tiny">Right player</div>
            <select id="cPlayerR"></select>
          </div>
          <div>
            <div class="tiny">Right game</div>
            <select id="cGameR"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <div class="tiny">Filter games by team (optional)</div>
            <select id="cTeam"></select>
          </div>
          <div>
            <div class="tiny">Filter start</div>
            <input type="date" id="cStart">
          </div>
          <div>
            <div class="tiny">Filter end</div>
            <input type="date" id="cEnd">
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn secondary" onclick="clearCompareFilters()">Clear filters</button>
          <button class="btn secondary" onclick="renderSummary()">Refresh</button>
        </div>
      </div>
    </div>

    <div class="card" id="summaryHeaderCard" style="display:none;">
      <h2>Selected game</h2>
      <div class="tiny" id="selectedGameHeader">‚Äî</div>
    </div>

    <div class="card">
      <h2>Results</h2>
      <div id="summaryOut" class="kpiGrid"></div>
      <div class="tiny" style="margin-top:10px;">
        Targets: Passes ‚â• 80% success, Tackles ‚â• 50% success.
      </div>
    </div>
  </section>

  <!-- MANAGE -->
  <section id="manage" style="display:none;">
    <div class="card">
      <h2>Players & Teams</h2>
      <div class="row">
        <div>
          <div class="tiny">Players</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
            <button class="btn secondary" onclick="addPlayer()">+ Add to roster</button>
          </div>
          <div id="playerList" style="margin-top:10px;"></div>
        </div>
        <div>
          <div class="tiny">Teams</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
            <button class="btn secondary" onclick="addTeam()">+ Add to roster</button>
          </div>
          <div id="teamList" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Data health</h2>
      <div class="tiny" id="dataHealth">‚Äî</div>
      <div style="margin-top:12px;">
        <button class="btn danger" onclick="resetAll()">Reset ALL data</button>
      </div>
      <div class="tiny" style="margin-top:8px;">Reset deletes players, teams, and games from this device.</div>
    </div>
  </section>
</main>

<script>
/* ===== storage keys ===== */
const K_PLAYERS = "cc_players";
const K_TEAMS   = "cc_teams";
const K_GAMES   = "cc_games";
const K_ACTIVE  = "cc_active_gameId";

/* ===== helpers ===== */
function $(id){ return document.getElementById(id); }
function uid(){ return "id_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36); }
function clampName(s){
  return (s || "").trim().replace(/\s+/g," ");
}
function prettyName(s){
  const x = clampName(s);
  if(!x) return x;
  return x.split(" ").map(w => w.slice(0,1).toUpperCase() + w.slice(1)).join(" ");
}
function loadJSON(key, fallback){
  try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
  catch { return fallback; }
}
function saveJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}
function pct(good, bad){
  const t = good + bad;
  if(!t) return "‚Äî";
  return Math.round((good / t) * 100) + "%";
}
function fmtGameLabel(g){
  return `${g.date} vs ${g.opponent || "Opponent?"} ‚Äî ${g.teamName || "Team?"}${g.venue ? " @ "+g.venue : ""}`;
}
function withinDate(dateStr, startStr, endStr){
  if(!dateStr) return false;
  if(startStr && dateStr < startStr) return false;
  if(endStr && dateStr > endStr) return false;
  return true;
}

/* ===== init defaults ===== */
function ensureDefaults(){
  const players = loadJSON(K_PLAYERS, []);
  const teams   = loadJSON(K_TEAMS, []);
  const games   = loadJSON(K_GAMES, []);

  if(Array.isArray(players)){
    players.forEach(p => { if(typeof p.archived !== "boolean") p.archived = false; });
    saveJSON(K_PLAYERS, players);
  }
  if(Array.isArray(teams)){
    teams.forEach(t => { if(typeof t.archived !== "boolean") t.archived = false; });
    saveJSON(K_TEAMS, teams);
  }

  if(teams.length === 0){
    const seed = [
      "Seattle Celtic G12 White",
      "Seattle Celtic G12 Green",
      "Seattle Celtic G12 GA",
      "Seattle United",
      "Indoor Team"
    ].map(n => ({id:uid(), name:n, archived:false}));
    saveJSON(K_TEAMS, seed);
  }
  if(players.length === 0){
    const seed = ["Sofia","Sophia","Harper"].map(n => ({id:uid(), name:n, archived:false}));
    saveJSON(K_PLAYERS, seed);
  }
  if(!Array.isArray(games)) saveJSON(K_GAMES, []);
}

/* ===== dropdown rendering ===== */
function renderDropdowns(){
  const playersAll = loadJSON(K_PLAYERS, []);
  const teamsAll   = loadJSON(K_TEAMS, []);
  const gamesAll   = loadJSON(K_GAMES, []).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));

  const players = playersAll.filter(p => !p.archived);
  const teams   = teamsAll.filter(t => !t.archived);

  $("gTeam").innerHTML = teams.map(t => `<option value="${t.id}">${t.name}</option>`).join("");

  const pOpts = players.map(p => `<option value="${p.id}">${p.name}</option>`).join("");
  $("pA").innerHTML = `<option value="">‚Äî select ‚Äî</option>${pOpts}`;
  $("pB").innerHTML = `<option value="">‚Äî select ‚Äî</option>${pOpts}`;

  $("sPlayerA").innerHTML = `<option value="">‚Äî select ‚Äî</option>${pOpts}`;
  $("sPlayerB").innerHTML = `<option value="">‚Äî none ‚Äî</option>${pOpts}`;

  $("cPlayerL").innerHTML = `<option value="">‚Äî select ‚Äî</option>${pOpts}`;
  $("cPlayerR").innerHTML = `<option value="">‚Äî select ‚Äî</option>${pOpts}`;

  $("sGame").innerHTML = gamesAll.map(g => `<option value="${g.id}">${fmtGameLabel(g)}</option>`).join("");

  $("fTeam").innerHTML = `<option value="">All teams</option>` + teams.map(t => `<option value="${t.id}">${t.name}</option>`).join("");
  $("cTeam").innerHTML = `<option value="">All teams</option>` + teams.map(t => `<option value="${t.id}">${t.name}</option>`).join("");

  renderGamePicker();
  renderCompareGamePickers();
  renderManageLists();
  renderSummary();
}

function renderManageLists(){
  const players = loadJSON(K_PLAYERS, []);
  const teams   = loadJSON(K_TEAMS, []);

  $("playerList").innerHTML = players.map(p =>
    `<div class="list-item">
      <div class="tableRow">
        <div>
          <b>${p.name}</b>
          ${p.archived ? `<span class="tagArchived">ARCHIVED</span>` : ``}
          <div class="tiny">id: ${p.id}</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="smallBtn" onclick="renamePlayer('${p.id}')">‚úèÔ∏è Rename</button>
          ${p.archived
            ? `<button class="smallBtn warn" onclick="unarchivePlayer('${p.id}')">‚ôªÔ∏è Unarchive</button>`
            : `<button class="smallBtn danger" onclick="archivePlayer('${p.id}')">üóëÔ∏è Archive</button>`
          }
        </div>
      </div>
    </div>`
  ).join("") || `<div class="tiny">No players yet.</div>`;

  $("teamList").innerHTML = teams.map(t =>
    `<div class="list-item">
      <div class="tableRow">
        <div>
          <b>${t.name}</b>
          ${t.archived ? `<span class="tagArchived">ARCHIVED</span>` : ``}
          <div class="tiny">id: ${t.id}</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="smallBtn" onclick="renameTeam('${t.id}')">‚úèÔ∏è Rename</button>
          ${t.archived
            ? `<button class="smallBtn warn" onclick="unarchiveTeam('${t.id}')">‚ôªÔ∏è Unarchive</button>`
            : `<button class="smallBtn danger" onclick="archiveTeam('${t.id}')">üóëÔ∏è Archive</button>`
          }
        </div>
      </div>
    </div>`
  ).join("") || `<div class="tiny">No teams yet.</div>`;

  const games = loadJSON(K_GAMES, []);
  const totalGames = games.length;
  const uniqPlayers = players.length;
  const totalPass = games.reduce((s,g)=> s + g.stats.A.passGood + g.stats.A.passBad + g.stats.B.passGood + g.stats.B.passBad, 0);
  const totalTack = games.reduce((s,g)=> s + g.stats.A.tackGood + g.stats.A.tackBad + g.stats.B.tackGood + g.stats.B.tackBad, 0);
  const last = games.slice().sort((a,b)=>(b.date||"").localeCompare(a.date||""))[0];
  $("dataHealth").innerHTML = `
    Games logged: <b>${totalGames}</b><br>
    Players in roster: <b>${uniqPlayers}</b><br>
    Total pass events: <b>${totalPass}</b><br>
    Total tackle events: <b>${totalTack}</b><br>
    Most recent game: <b>${last ? fmtGameLabel(last) : "‚Äî"}</b>
  `;
}

/* ===== tab ===== */
function showTab(t){
  ["game","summary","manage"].forEach(x=>{
    $(x).style.display = (x===t) ? "block" : "none";
    $("tab-"+x).classList.toggle("active", x===t);
  });
}

/* ===== game session ===== */
function currentGameId(){
  return localStorage.getItem(K_ACTIVE) || "";
}
function setCurrentGameId(id){
  if(id) localStorage.setItem(K_ACTIVE, id);
  else localStorage.removeItem(K_ACTIVE);
}

function emptyStats(){
  return {passGood:0, passBad:0, tackGood:0, tackBad:0, shotGood:0, shotBad:0, goalGood:0, goalBad:0};
}

function setButtonsEnabled(enabled){
  const ids = ["btnAPG","btnAPB","btnATG","btnATB","btnASG","btnASB","btnAGG","btnAGB","btnBPG","btnBPB","btnBTG","btnBTB","btnBSG","btnBSB","btnBGG","btnBGB","btnUndoA","btnUndoB"];
  ids.forEach(i => $(i).disabled = !enabled);
  $("gNotes").readOnly = !enabled;
}

function updateLiveUI(game){
  if(!game){
    $("gameKeyPill").textContent = "‚Äî";
    $("gameStateBadge").textContent = "NO GAME LOADED";
    $("gameStateBadge").className = "badge";
    $("nameA").textContent = "‚Äî";
    $("nameB").textContent = "‚Äî";
    setButtonsEnabled(false);
    $("btnStart").disabled = false;
    $("btnEnd").disabled = true;
    $("btnUnlock").disabled = true;
    return;
  }

  $("gameKeyPill").textContent = game.id;
  $("nameA").textContent = game.playerAName || "‚Äî";
  $("nameB").textContent = game.playerBName || "‚Äî";
  $("gNotes").value = game.notes || "";

  const live = !game.locked;
  $("gameStateBadge").textContent = live ? "IN PROGRESS" : "LOCKED ‚úÖ";
  $("gameStateBadge").className = "badge " + (live ? "live" : "locked");

  $("btnStart").disabled  = !!game && !game.locked;
  $("btnEnd").disabled    = !game || game.locked;
  $("btnUnlock").disabled = !game || !game.locked;

  setButtonsEnabled(live);

  const A = game.stats.A, B = game.stats.B;
  $("aPassGood").textContent = A.passGood; $("aPassBad").textContent = A.passBad;
  $("aTackGood").textContent = A.tackGood; $("aTackBad").textContent = A.tackBad;
  $("aShotGood").textContent = A.shotGood || 0; $("aShotBad").textContent = A.shotBad || 0;
  $("aGoalGood").textContent = A.goalGood || 0; $("aGoalBad").textContent = A.goalBad || 0;
  $("aPassRate").textContent = pct(A.passGood, A.passBad);
  $("aTackRate").textContent = pct(A.tackGood, A.tackBad);
  $("aShotRate").textContent = pct(A.shotGood || 0, A.shotBad || 0);
  $("aGoalRate").textContent = pct(A.goalGood || 0, A.goalBad || 0);

  $("bPassGood").textContent = B.passGood; $("bPassBad").textContent = B.passBad;
  $("bTackGood").textContent = B.tackGood; $("bTackBad").textContent = B.tackBad;
  $("bShotGood").textContent = B.shotGood || 0; $("bShotBad").textContent = B.shotBad || 0;
  $("bGoalGood").textContent = B.goalGood || 0; $("bGoalBad").textContent = B.goalBad || 0;
  $("bPassRate").textContent = pct(B.passGood, B.passBad);
  $("bTackRate").textContent = pct(B.tackGood, B.tackBad);
  $("bShotRate").textContent = pct(B.shotGood || 0, B.shotBad || 0);
  $("bGoalRate").textContent = pct(B.goalGood || 0, B.goalBad || 0);
}

function getGame(id){
  const games = loadJSON(K_GAMES, []);
  return games.find(g => g.id === id) || null;
}
function saveGame(updated){
  const games = loadJSON(K_GAMES, []);
  const idx = games.findIndex(g => g.id === updated.id);
  if(idx >= 0) games[idx] = updated;
  else games.push(updated);
  saveJSON(K_GAMES, games);
  renderDropdowns();
}

function startGame(){
  const date = $("gDate").value;
  const venue = clampName($("gVenue").value);
  const teamId = $("gTeam").value;

  const teams = loadJSON(K_TEAMS, []);
  const team = teams.find(t => t.id === teamId);
  const teamName = team ? team.name : "";

  const opponent = clampName($("gOpp").value);
  const playerAId = $("pA").value;
  const playerBId = $("pB").value;

  const players = loadJSON(K_PLAYERS, []);
  const A = players.find(p => p.id === playerAId);
  const B = players.find(p => p.id === playerBId);

  if(!date){ alert("Pick a game date."); return; }
  if(!teamId){ alert("Select team played for."); return; }
  if(!playerAId || !playerBId){ alert("Select two players."); return; }
  if(playerAId === playerBId){ alert("Pick two different players."); return; }

  const newGame = {
    id: uid(),
    date,
    venue,
    teamId,
    teamName,
    opponent,
    playerAId,
    playerAName: A ? A.name : "Player A",
    playerBId,
    playerBName: B ? B.name : "Player B",
    stats: {A: emptyStats(), B: emptyStats()},
    stacks: {A: [], B: []},
    notes: "",
    locked: false,
    startedAt: new Date().toISOString(),
    endedAt: ""
  };

  setCurrentGameId(newGame.id);
  saveGame(newGame);
  updateLiveUI(newGame);
  showTab("game");
}

function endGame(){
  const id = currentGameId();
  if(!id){ alert("No active game loaded."); return; }
  const game = getGame(id);
  if(!game) return;

  if(!confirm("End game and LOCK stats + notes?\n\nYou can unlock later to amend notes/stats.")) return;

  game.locked = true;
  game.endedAt = new Date().toISOString();
  saveGame(game);
  updateLiveUI(game);
}

function unlockGame(){
  const id = currentGameId();
  if(!id){ alert("No active game loaded."); return; }
  const game = getGame(id);
  if(!game) return;

  if(!confirm("Unlock this game for edits?\n\n(You can lock it again when done.)")) return;

  game.locked = false;
  saveGame(game);
  updateLiveUI(game);
}

function loadGame(id){
  const game = getGame(id);
  if(!game){ alert("Game not found."); return; }

  $("gDate").value = game.date || "";
  $("gVenue").value = game.venue || "";
  $("gOpp").value = game.opponent || "";

  ensureIdInSelect("gTeam", game.teamId, game.teamName || "Team?");
  ensureIdInSelect("pA", game.playerAId, game.playerAName || "Player A");
  ensureIdInSelect("pB", game.playerBId, game.playerBName || "Player B");

  setCurrentGameId(game.id);
  updateLiveUI(game);
  showTab("game");
}

function ensureIdInSelect(selectId, val, label){
  const sel = $(selectId);
  if(!val) return;
  const exists = Array.from(sel.options).some(o => o.value === val);
  if(!exists){
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = `${label} (archived)`;
    sel.appendChild(opt);
  }
  sel.value = val;
}

function tap(side, action){
  const id = currentGameId();
  if(!id) return;
  const game = getGame(id);
  if(!game || game.locked) return;

  const bucket = (side === "A") ? game.stats.A : game.stats.B;
  const stack  = (side === "A") ? game.stacks.A : game.stacks.B;

  if(action === "passGood") bucket.passGood++;
  if(action === "passBad")  bucket.passBad++;
  if(action === "tackGood") bucket.tackGood++;
  if(action === "tackBad")  bucket.tackBad++;
  if(action === "shotGood") bucket.shotGood++;
  if(action === "shotBad")  bucket.shotBad++;
  if(action === "goalGood") bucket.goalGood++;
  if(action === "goalBad")  bucket.goalBad++;

  stack.push({action, ts: Date.now()});

  game.notes = $("gNotes").value;

  saveGame(game);
  updateLiveUI(game);
}

function undo(side){
  const id = currentGameId();
  if(!id) return;
  const game = getGame(id);
  if(!game || game.locked) return;

  const bucket = (side === "A") ? game.stats.A : game.stats.B;
  const stack  = (side === "A") ? game.stacks.A : game.stacks.B;

  const last = stack.pop();
  if(!last){ return; }

  const a = last.action;
  if(a === "passGood" && bucket.passGood > 0) bucket.passGood--;
  if(a === "passBad"  && bucket.passBad  > 0) bucket.passBad--;
  if(a === "tackGood" && bucket.tackGood > 0) bucket.tackGood--;
  if(a === "tackBad"  && bucket.tackBad  > 0) bucket.tackBad--;
  if(a === "shotGood" && bucket.shotGood > 0) bucket.shotGood--;
  if(a === "shotBad"  && bucket.shotBad  > 0) bucket.shotBad--;
  if(a === "goalGood" && bucket.goalGood > 0) bucket.goalGood--;
  if(a === "goalBad"  && bucket.goalBad  > 0) bucket.goalBad--;

  game.notes = $("gNotes").value;

  saveGame(game);
  updateLiveUI(game);
}

$("gNotes").addEventListener("input", () => {
  const id = currentGameId();
  const game = id ? getGame(id) : null;
  if(!game || game.locked) return;
  game.notes = $("gNotes").value;
  saveGame(game);
});

/* ===== add player/team ===== */
function addPlayer(){
  const raw = prompt("New player name (adds to roster):");
  const name = prettyName(raw);
  if(!name) return;

  const players = loadJSON(K_PLAYERS, []);
  if(players.some(p => (p.name || "").toLowerCase() === name.toLowerCase() && !p.archived)){
    alert("That player already exists.");
    return;
  }
  players.push({id:uid(), name, archived:false});
  saveJSON(K_PLAYERS, players);
  renderDropdowns();
}

function addTeam(){
  const raw = prompt("New team name (adds to roster):");
  const name = clampName(raw);
  if(!name) return;

  const teams = loadJSON(K_TEAMS, []);
  if(teams.some(t => (t.name || "").toLowerCase() === name.toLowerCase() && !t.archived)){
    alert("That team already exists.");
    return;
  }
  teams.push({id:uid(), name, archived:false});
  saveJSON(K_TEAMS, teams);
  renderDropdowns();
}

/* ===== manage ===== */
function renamePlayer(id){
  const players = loadJSON(K_PLAYERS, []);
  const p = players.find(x => x.id === id);
  if(!p) return;
  const raw = prompt("Rename player to:", p.name || "");
  const name = prettyName(raw);
  if(!name) return;

  if(players.some(x => x.id !== id && !x.archived && (x.name || "").toLowerCase() === name.toLowerCase())){
    alert("That name already exists in active roster.");
    return;
  }

  p.name = name;
  saveJSON(K_PLAYERS, players);

  const games = loadJSON(K_GAMES, []);
  games.forEach(g => {
    if(g.playerAId === id) g.playerAName = name;
    if(g.playerBId === id) g.playerBName = name;
  });
  saveJSON(K_GAMES, games);

  renderDropdowns();
}
function archivePlayer(id){
  const players = loadJSON(K_PLAYERS, []);
  const p = players.find(x => x.id === id);
  if(!p) return;
  if(!confirm(`Archive player "${p.name}"?\n\nArchived players are hidden from dropdowns, but old games keep their history.`)) return;
  p.archived = true;
  saveJSON(K_PLAYERS, players);
  renderDropdowns();
}
function unarchivePlayer(id){
  const players = loadJSON(K_PLAYERS, []);
  const p = players.find(x => x.id === id);
  if(!p) return;
  p.archived = false;
  saveJSON(K_PLAYERS, players);
  renderDropdowns();
}

function renameTeam(id){
  const teams = loadJSON(K_TEAMS, []);
  const t = teams.find(x => x.id === id);
  if(!t) return;
  const raw = prompt("Rename team to:", t.name || "");
  const name = clampName(raw);
  if(!name) return;

  if(teams.some(x => x.id !== id && !x.archived && (x.name || "").toLowerCase() === name.toLowerCase())){
    alert("That name already exists in active roster.");
    return;
  }

  t.name = name;
  saveJSON(K_TEAMS, teams);

  const games = loadJSON(K_GAMES, []);
  games.forEach(g => {
    if(g.teamId === id) g.teamName = name;
  });
  saveJSON(K_GAMES, games);

  renderDropdowns();
}
function archiveTeam(id){
  const teams = loadJSON(K_TEAMS, []);
  const t = teams.find(x => x.id === id);
  if(!t) return;
  if(!confirm(`Archive team "${t.name}"?\n\nArchived teams are hidden from dropdowns, but old games keep their history.`)) return;
  t.archived = true;
  saveJSON(K_TEAMS, teams);
  renderDropdowns();
}
function unarchiveTeam(id){
  const teams = loadJSON(K_TEAMS, []);
  const t = teams.find(x => x.id === id);
  if(!t) return;
  t.archived = false;
  saveJSON(K_TEAMS, teams);
  renderDropdowns();
}

/* ===== game picker ===== */
function clearGameFilters(){
  $("fTeam").value = "";
  $("fStart").value = "";
  $("fEnd").value = "";
  renderGamePicker();
}
function renderGamePicker(){
  const teamId = $("fTeam").value;
  const start = $("fStart").value;
  const end = $("fEnd").value;

  const gamesAll = loadJSON(K_GAMES, []).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));

  const filtered = gamesAll.filter(g => {
    if(teamId && g.teamId !== teamId) return false;
    if((start || end) && !withinDate(g.date, start, end)) return false;
    return true;
  });

  $("gamePicker").innerHTML = filtered.length
    ? `<option value="">‚Äî select a game ‚Äî</option>` + filtered.map(g => `<option value="${g.id}">${fmtGameLabel(g)}${g.locked ? " [LOCKED]" : ""}</option>`).join("")
    : `<option value="">‚Äî no games match ‚Äî</option>`;

  $("gamePicker").value = "";
}
$("fTeam").addEventListener("change", renderGamePicker);
$("fStart").addEventListener("change", renderGamePicker);
$("fEnd").addEventListener("change", renderGamePicker);
$("gamePicker").addEventListener("change", () => {
  const id = $("gamePicker").value;
  if(id) loadGame(id);
});

/* ===== summary (unchanged logic from your deployed version) ===== */
function gamesForRange(range){
  const games = loadJSON(K_GAMES, []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  if(range === "all") return games;
  if(range === "last5") return games.slice(-5);
  if(range === "single"){
    const id = $("sGame").value;
    return id ? games.filter(g => g.id === id) : [];
  }
  if(range === "custom"){
    const start = $("sStart").value;
    const end = $("sEnd").value;
    if(!start || !end) return [];
    return games.filter(g => withinDate(g.date, start, end));
  }
  return games;
}

function aggForPlayer(games, playerId){
  const out = {
    passGood:0, passBad:0, tackGood:0, tackBad:0, shotGood:0, shotBad:0, goalGood:0, goalBad:0,
    games:0,
    bestPass:null, bestTack:null,
    last3: {passGood:0, passBad:0, tackGood:0, tackBad:0, shotGood:0, shotBad:0, goalGood:0, goalBad:0, games:0},
    prior: {passGood:0, passBad:0, tackGood:0, tackBad:0, shotGood:0, shotBad:0, goalGood:0, goalBad:0, games:0}
  };

  const sorted = games.slice().sort((a,b)=>(a.date||"").localeCompare(b.date||""));
  const perGame = [];

  sorted.forEach(g=>{
    let side = null;
    if(g.playerAId === playerId) side = "A";
    if(g.playerBId === playerId) side = "B";
    if(!side) return;

    const s = (side==="A") ? g.stats.A : g.stats.B;
    out.passGood += s.passGood;
    out.passBad  += s.passBad;
    out.tackGood += s.tackGood;
    out.tackBad  += s.tackBad;
    out.shotGood += s.shotGood || 0;
    out.shotBad  += s.shotBad || 0;
    out.goalGood += s.goalGood || 0;
    out.goalBad  += s.goalBad || 0;
    out.games++;

    perGame.push({game:g, s});
  });

  perGame.forEach(x=>{
    const pg = x.s.passGood, pb = x.s.passBad;
    const tg = x.s.tackGood, tb = x.s.tackBad;
    const pTot = pg + pb;
    const tTot = tg + tb;

    if(pTot >= 10){
      const rate = pg / pTot;
      if(!out.bestPass || rate > out.bestPass.rate) out.bestPass = {rate, ...x};
    }
    if(tTot >= 4){
      const rate = tg / tTot;
      if(!out.bestTack || rate > out.bestTack.rate) out.bestTack = {rate, ...x};
    }
  });

  const pGames = perGame;
  const last3 = pGames.slice(-3);
  const prior = pGames.slice(0, Math.max(0, pGames.length - 3));

  function addTo(bucket, arr){
    arr.forEach(x=>{
      bucket.passGood += x.s.passGood;
      bucket.passBad  += x.s.passBad;
      bucket.tackGood += x.s.tackGood;
      bucket.tackBad  += x.s.tackBad;
      bucket.shotGood += x.s.shotGood || 0;
      bucket.shotBad  += x.s.shotBad || 0;
      bucket.goalGood += x.s.goalGood || 0;
      bucket.goalBad  += x.s.goalBad || 0;
      bucket.games++;
    });
  }
  addTo(out.last3, last3);
  addTo(out.prior, prior);

  return out;
}

function playerStatsForSingleGame(game, playerId){
  if(!game || !playerId) return null;
  let side = null;
  if(game.playerAId === playerId) side = "A";
  if(game.playerBId === playerId) side = "B";
  if(!side) return null;
  const s = (side==="A") ? game.stats.A : game.stats.B;
  return { side, s };
}

function rateText(good, bad){
  const total = good + bad;
  if(!total) return "‚Äî";
  return `${good}/${total} (${Math.round((good/total)*100)}%)`;
}

function passTargetBadge(good, bad){
  const total = good + bad;
  if(!total) return `<span class="pill">‚Äî</span>`;
  const r = good / total;
  if(r >= 0.80) return `<span class="pill"><span class="good">‚úÖ</span> ‚â•80%</span>`;
  return `<span class="pill"><span class="bad">‚ö†Ô∏è</span> <80%</span>`;
}
function tackTargetBadge(good, bad){
  const total = good + bad;
  if(!total) return `<span class="pill">‚Äî</span>`;
  const r = good / total;
  if(r >= 0.50) return `<span class="pill"><span class="good">‚úÖ</span> ‚â•50%</span>`;
  return `<span class="pill"><span class="bad">‚ö†Ô∏è</span> <50%</span>`;
}

function trendLine(label, bucket){
  const totP = bucket.passGood + bucket.passBad;
  const totT = bucket.tackGood + bucket.tackBad;
  const totS = (bucket.shotGood || 0) + (bucket.shotBad || 0);
  const totG = (bucket.goalGood || 0) + (bucket.goalBad || 0);
  const p = totP ? Math.round((bucket.passGood/totP)*100) + "%" : "‚Äî";
  const t = totT ? Math.round((bucket.tackGood/totT)*100) + "%" : "‚Äî";
  const s = totS ? Math.round(((bucket.shotGood || 0)/totS)*100) + "%" : "‚Äî";
  const g = totG ? Math.round(((bucket.goalGood || 0)/totG)*100) + "%" : "‚Äî";
  return `<div class="tiny">${label}: Pass ${p} | Tack ${t} | Shot ${s} | Goal ${g} (${bucket.games} games)</div>`;
}

function buildAggregateBlock(name, agg){
  const pass = rateText(agg.passGood, agg.passBad);
  const tack = rateText(agg.tackGood, agg.tackBad);
  const shot = rateText(agg.shotGood || 0, agg.shotBad || 0);
  const goal = rateText(agg.goalGood || 0, agg.goalBad || 0);

  const bestPass = agg.bestPass ? `${Math.round(agg.bestPass.rate*100)}% ‚Äî ${fmtGameLabel(agg.bestPass.game)}` : "‚Äî (need ‚â•10 attempts)";
  const bestTack = agg.bestTack ? `${Math.round(agg.bestTack.rate*100)}% ‚Äî ${fmtGameLabel(agg.bestTack.game)}` : "‚Äî (need ‚â•4 attempts)";

  return `
    <div class="kpi">
      <h4>${name}</h4>

      <div class="kpiRow"><b>Passes</b><span>${pass} ${passTargetBadge(agg.passGood, agg.passBad)}</span></div>
      <div class="kpiRow"><b>Tackles</b><span>${tack} ${tackTargetBadge(agg.tackGood, agg.tackBad)}</span></div>
      <div class="kpiRow"><b>Shots</b><span>${shot}</span></div>
      <div class="kpiRow"><b>Goals</b><span>${goal}</span></div>

      <div class="target">Best pass game: <b>${bestPass}</b></div>
      <div class="target">Best tackle game: <b>${bestTack}</b></div>

      <div class="divider" style="margin:10px 0;"></div>
      <div class="tiny"><b>Trend</b> (last 3 vs prior)</div>
      ${trendLine("Last 3", agg.last3)}
      ${trendLine("Prior", agg.prior)}
    </div>
  `;
}

function buildSingleGameBlock(title, game, playerId){
  const players = loadJSON(K_PLAYERS, []);
  const p = players.find(x => x.id === playerId);
  const label = p ? p.name : title;

  if(!game){
    return `<div class="kpi"><h4>${label}</h4><div class="tiny">Pick a game.</div></div>`;
  }

  const ps = playerStatsForSingleGame(game, playerId);
  if(!ps){
    return `
      <div class="kpi">
        <h4>${label}</h4>
        <div class="tiny">Selected player not found in that game.</div>
        <div class="target">${fmtGameLabel(game)}</div>
      </div>
    `;
  }

  const s = ps.s;
  const pass = rateText(s.passGood, s.passBad);
  const tack = rateText(s.tackGood, s.tackBad);
  const shot = rateText(s.shotGood || 0, s.shotBad || 0);
  const goal = rateText(s.goalGood || 0, s.goalBad || 0);

  return `
    <div class="kpi">
      <h4>${label}</h4>
      <div class="tiny">${fmtGameLabel(game)}</div>

      <div class="divider" style="margin:10px 0;"></div>

      <div class="kpiRow"><b>Passes</b><span>${pass} ${passTargetBadge(s.passGood, s.passBad)}</span></div>
      <div class="kpiRow"><b>Tackles</b><span>${tack} ${tackTargetBadge(s.tackGood, s.tackBad)}</span></div>
      <div class="kpiRow"><b>Shots</b><span>${shot}</span></div>
      <div class="kpiRow"><b>Goals</b><span>${goal}</span></div>

      <div class="divider" style="margin:10px 0;"></div>
      <div class="tiny"><b>Notes</b></div>
      <div class="mutebox">${(game.notes || "‚Äî").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
    </div>
  `;
}

function renderCompareGamePickers(){
  const teamId = $("cTeam").value;
  const start = $("cStart").value;
  const end = $("cEnd").value;

  const gamesAll = loadJSON(K_GAMES, []).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));
  const filtered = gamesAll.filter(g => {
    if(teamId && g.teamId !== teamId) return false;
    if((start || end) && !withinDate(g.date, start, end)) return false;
    return true;
  });

  const options = filtered.map(g => `<option value="${g.id}">${fmtGameLabel(g)}</option>`).join("");
  $("cGameL").innerHTML = `<option value="">‚Äî select ‚Äî</option>` + options;
  $("cGameR").innerHTML = `<option value="">‚Äî select ‚Äî</option>` + options;
}

function clearCompareFilters(){
  $("cTeam").value = "";
  $("cStart").value = "";
  $("cEnd").value = "";
  renderCompareGamePickers();
}

$("cTeam").addEventListener("change", renderCompareGamePickers);
$("cStart").addEventListener("change", renderCompareGamePickers);
$("cEnd").addEventListener("change", renderCompareGamePickers);

function renderSummary(){
  const mode = $("sumMode").value;

  $("aggregateControls").style.display = (mode === "aggregate") ? "block" : "none";
  $("gameCompareControls").style.display = (mode === "gameCompare") ? "block" : "none";

  const range = $("sRange").value;
  $("customRangeBox").style.display = (range === "custom") ? "block" : "none";

  const headerCard = $("summaryHeaderCard");

  if(mode === "aggregate"){
    const games = gamesForRange(range);

    if(range === "single" && games.length === 1){
      headerCard.style.display = "block";
      $("selectedGameHeader").textContent = fmtGameLabel(games[0]);
    } else if(range === "custom"){
      headerCard.style.display = "block";
      const start = $("sStart").value || "‚Äî";
      const end = $("sEnd").value || "‚Äî";
      $("selectedGameHeader").textContent = `Custom range: ${start} to ${end} (${games.length} games)`;
    } else {
      headerCard.style.display = "none";
    }

    const idA = $("sPlayerA").value;
    const idB = $("sPlayerB").value;

    const players = loadJSON(K_PLAYERS, []);
    const pA = players.find(p=>p.id===idA);
    const pB = players.find(p=>p.id===idB);

    const blocks = [];

    if(range === "custom" && (!$("sStart").value || !$("sEnd").value)){
      $("summaryOut").innerHTML = `<div class="tiny">Pick both start and end date for custom range.</div>`;
      return;
    }

    if(idA){
      const aggA = aggForPlayer(games, idA);
      blocks.push(buildAggregateBlock(pA ? pA.name : "Player A", aggA));
    }
    if(idB){
      const aggB = aggForPlayer(games, idB);
      blocks.push(buildAggregateBlock(pB ? pB.name : "Player B", aggB));
    }

    $("summaryOut").innerHTML = blocks.length ? blocks.join("") : `<div class="tiny">Select a player to see summary.</div>`;
    return;
  }

  headerCard.style.display = "none";

  renderCompareGamePickers();

  const gL = $("cGameL").value ? getGame($("cGameL").value) : null;
  const gR = $("cGameR").value ? getGame($("cGameR").value) : null;
  const pL = $("cPlayerL").value;
  const pR = $("cPlayerR").value;

  const blocks = [];
  blocks.push(buildSingleGameBlock("Left", gL, pL));
  blocks.push(buildSingleGameBlock("Right", gR, pR));

  $("summaryOut").innerHTML = blocks.join("");
}

/* ===== reset ===== */
function resetAll(){
  if(!confirm("Reset ALL data on this device?\n\nThis deletes players, teams, and games.")) return;
  localStorage.removeItem(K_PLAYERS);
  localStorage.removeItem(K_TEAMS);
  localStorage.removeItem(K_GAMES);
  localStorage.removeItem(K_ACTIVE);
  ensureDefaults();
  renderDropdowns();
  setCurrentGameId("");
  updateLiveUI(null);
  alert("Reset complete.");
}

/* ===== init ===== */
function init(){
  ensureDefaults();

  const today = new Date().toISOString().slice(0,10);
  $("gDate").value = today;

  renderDropdowns();

  const d = new Date();
  const end = d.toISOString().slice(0,10);
  d.setDate(d.getDate() - 30);
  const start = d.toISOString().slice(0,10);
  $("sStart").value = start;
  $("sEnd").value = end;

  const id = currentGameId();
  if(id){
    const game = getGame(id);
    if(game){
      $("gDate").value = game.date || today;
      $("gVenue").value = game.venue || "";
      $("gOpp").value = game.opponent || "";
      ensureIdInSelect("gTeam", game.teamId, game.teamName || "Team?");
      ensureIdInSelect("pA", game.playerAId, game.playerAName || "Player A");
      ensureIdInSelect("pB", game.playerBId, game.playerBName || "Player B");
      updateLiveUI(game);
    } else {
      setCurrentGameId("");
      updateLiveUI(null);
    }
  } else {
    updateLiveUI(null);
  }

  ["sumMode","sPlayerA","sPlayerB","sGame","sRange","sStart","sEnd","cPlayerL","cPlayerR","cGameL","cGameR"].forEach(id=>{
    const el = $(id);
    if(el) el.addEventListener("change", renderSummary);
  });

  renderSummary();

  $("pA").addEventListener("change", ()=> {
    const players = loadJSON(K_PLAYERS, []).filter(p => !p.archived);
    const A = players.find(p=>p.id===$("pA").value);
    $("nameA").textContent = A ? A.name : "‚Äî";
  });
  $("pB").addEventListener("change", ()=> {
    const players = loadJSON(K_PLAYERS, []).filter(p => !p.archived);
    const B = players.find(p=>p.id===$("pB").value);
    $("nameB").textContent = B ? B.name : "‚Äî";
  });
}

init();

/* ===== PWA register ===== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
}
</script>
</body>
</html>
